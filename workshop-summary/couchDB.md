## CouchDB Basics

### Getting Start

Action	HTTP METHOD

Purpose  | Method
------------- | -------------
Create Resource | PUT
Retrieve Resource  | GET
Update Resource	| POST
Delete Resource | DELETE

Adding and deleting a database is done through a HTTP call: (e.g. new database called exampledb)

```shell
curl -X PUT “http://localhost:5984/<new database name>“
curl -X DELETE “http://localhost:5984/exampledb“
```
Listing all databases of an instance

```
curl -X GET “http://localhost:5984/_all_dbs”
```
### System properties of document
In every CouchDB instance there are system databases. These are prefixed by underscore, such as `_users`

• `_id`: is the ID of a single document which can be set during the document load; by default it is generated by CouchDB and guaranteed to be unique
• `_rev`: revision number of a document. It is guaranteed to be increasing per document,i.e. every database instance will pick up the same revision as the current
version of the document

### Insertion & retrieval of document

Insert document

```shell
curl -X POST "http://localhost:5984/exampledb" 
--header "Content-Type:application/json" 
--data '{"type": "account", "holder": "Alice","initialbalance": 1000}'
```
response

```
{"ok":true,"id":"c43bcff2cdbb577d8ab2933cdc0011f8","rev":"1-
b8a039a8143b474b3601b389081a9eec"}
```

To retrieve a document:

```
curl -X GET “http://localhost:5984/exampledb/c43bcff2cdbb577d8ab2933cdc0011f8”
```
response:

```
{"_id":"c43bcff2cd577d8ab2933cdc0011f8","_rev":"1-
b8a039a8143b474b3601b389081a9eec","type":"account","holder":"Alice","initial
balance":1000}
```
### Deal with update conflicts

*Deal with conflicts with single node:*

Update document: Request to name the ID of a new document (note PUT instead of POST):
> * Remember to add revision number (i.e.charlie?rev=1-faff5448bf3051ac4fb8f1cc2b04bc51 ), otherwise may result in conflicts
> * "charlie" is the doc name


```
curl -X PUT "http://localhost:5984/exampledb/charlie?rev=1-
faff5448bf3051ac4fb8f1cc2b04bc51" --header "Content-Type:application/json" 
--data'{"type": "account", "holder": "Charlie", "initialbalance": 200}'
```
*Deal with conflict in partitioned nodes in couchDB cluster(to be finished):*

To help in the merging of conflicting revisions, CouchDB can return all the conflicts in a database

```
GET /exampledb/_all_docs?include_docs=true&conflicts=true
```

### Deletion of documents

How to delete document (note the revision number: change from 2 to 3 in the response):

```
curl -X DELETE "http://localhost:5984/exampledb/charlie?rev=2-c0716f36b7cb2b2d31102fe807697573"
```
> response: 200

```
{"ok":true,"id":"charlie","rev":"3-320d11c2d78a18ccc0220086c418cc41"}
```
To check the deletion:

```
curl -X GET "http://localhost:5984/exampledb/charlie"
```

> Response: 404 (note, the reason is not “missing”, it is “deleted”):

```
{"error":"not_found","reason":"deleted"}
```

Actually, documents are not deleted until they are “purged”, hence they can be retrieved with a bit of effort (e.g. add document with the same id, then retrieve the old revision).

Delete a document permanently (add `_purge` )

```
curl -X POST "http://localhost:5984/exampledb/_purge" --header "Content-
Type:application/json" --data '{"charlie": ["3-
320d11c2d78a18ccc0220086c418cc41"]}'
```
> Response: 200

```
{"purge_seq":2,"purged":{"charlie":["3-320d11c2d78a18ccc0220086c418cc41"]}}
```
> • Every document and revision has to be specified for CouchDB to delete them, e.g.:
```
curl -X GET "http://localhost:5984/exampledb/charlie"
```
Response: 200 (now document is not just “deleted”, it is “missing”, as didn't specify the revision number):
```
{"error":"not_found","reason":"missing"}
```

Deletion of old version (use `_compact` )

The accumulation of old revisions can bloat a database, but automatic deletion and compaction is available:
> * The compaction can be tailored by setting a limit on the number of revisions
stored before deletion,
> * Compacting a database is long and entails duplicating some data during the
compaction, hence is something you may want to avoid or limit to the
absolute minimum

```
curl -X POST
“http://localhost:5984/my_db/_compact“ --header "Content-Type:application/json"
```
### Documents Can Be Bulk-managed
● Documents can be bulk loaded, deleted or updated via the CouchDB bulk docs API:

```
curl -v -X POST "http://localhost:5984/exampledb/_bulk_docs" --header
"Content-Type:application/json" --data
'{"docs":[{"name":"joe"},{"name":"bob"}]}'
```
> Response: 200

```
[{"ok":true,"id":"c43bcff2cdbb577d8ab2933cdc18f402","rev":"1-
c8cae35f4287628c696193172096c988"},{"ok":true,"id":"c43bcff2cdbb577d8ab2933c
dc18f796","rev":"1-c9f1576d06e12af51ece1bac75b26bad"}]
```
● The same POST request can be used to update documents (revision numbers and ids need to be provided in the JSON with `_id` and `_rev` attributes respectively)

## Querying a CouchDB Database

### CouchDB view intro

**CouchDB views are ==not==:**
• Relational SQL Queries (they are not volatile)
• Relational Views (the selected data are persisted)
• Indexes (data are persisted together with the index)

Long story short: views are fast and store aggregated data (which is great for analytics), but are inflexible and use a lot of storage

**CouuchDB types of views:**
● MapReduce Views: results of MapReduce processes that are written as B-tree indexes to disk and become part of the database

● Mango Queries: queries expressed in JSON, following the MongoDB queries syntax (Mango queries can also use B-tree indexes to speed-up computations)

● Full-text search: queries that can search form specific works or portions of words (via the Closueau plugin, running in a separate JVM instance)


### MapReduce View

● `keys` parameter: an array of keys, as returned by the view (null when rereduce is true), ==keys can be composited==
● `values` parameter: an array of values, as returned by the view
● `rereduce` parameter: if false, the reduce is still in its first stage (values are the disaggregated ones); if true, the reduce has already happened at least once, and the function works on aggregated keys and values (hence the keys parameter is null)

A database composed of document such as:

```
{"_id": "c43bcff2cdbb577d8ab2933cdc18f402",
"name": "Chris White",
"type": "transaction",
"amount": 100}
```
Use MapReduce returns the balance of every account holder

map.js:

```
function(doc) {emit([doc.name], doc.amount);}
```
reduce.js

```
function(keys, values, rereduce) {return sum(values);}
```

Call the view from HTTP request

```
curl XGET http://localhost:5984/exampledb/_design/example/_view/wc2
?group_level=2&startkey=[“a”,null]&endkey=[“c”,{}]
```

● Explainations
> 	○ are grouped into design documents `example`;
	○ may be passed the level of aggregation (`group_level`);
	○ may return only a subset of keys (`start_key, end_key` parameters);
	○ are persisted to disk, hence adding an entire document in the view result would duplicate disk space, such as in `emit(words[i],doc)` (don't! Use include_docs=true instead);
	○ Since there is no schema and documents of different types are often stored in the same database, it is useful to add a type attribute to docs, which comes in handy when defining views.
	○ You don’t run the JavaScript function yourself. Instead, when you query your view, ==CouchDB takes the source code and runs it for you on every document in the database your view was defined in==.
	
*Other examples, from external source:*

* In the code example, reduce need to set to true

```
curl -XGET "http://${user}:${pass}@localhost:${master_port}/twitter/_design/language/_view/language?reduce=true&group_level=1"
```
## Other operations

### Partitioned Database
● A partitioned database can be created by adding the parameter `partitioned` :

```
curl -X PUT "http://localhost:5984/testpart?partitioned=true"
--user '<username>:<password>'
```
details of how it works https://docs.couchdb.org/en/stable/partitioned-dbs/index.html

### Replication
● There is a system `_replicator` database that holds all the replications to be performed on the CouchDB instance; adding a replication is just a POST away:

```
curl -H 'Content-Type: application/json' -X POST
http://localhost:5984/_replicate -d ' {"source":
"http://myserver:5984/foo", "target": "bar",
"create_target": true, "continuous": true}'
```
● Note the `continuous` attribute is set to true; if this were false, the database instance would be replicated ==only once==
● To cancel a replication, just issue the same exact JSON, but with an additional `cancel` attribute set to true
● Replications are ==uni-directional==, for a properly balanced system, you need to add two replications

## CouchDB Cluster

`GET/_membership`: Displays the nodes that are part of the cluster as cluster_nodes

